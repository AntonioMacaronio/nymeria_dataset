#!/usr/bin/env python3
"""
Find HDF5 files in S3 bucket that don't have corresponding MP4 files.
Writes AWS CLI delete commands to a text file.
"""

import subprocess
import os
from pathlib import Path
from typing import Set

# Configuration from batch_download_upload_mp4.py
S3_BUCKET_PREFIX = "s3://far-research-internal/antzhan/nymeria/mp4"
AWS_PROFILE = "far-compute"
AWS_REGION = "us-west-2"
OUTPUT_FILE = "delete_orphaned_hdf5_commands.txt"


def list_s3_files(s3_prefix: str, aws_profile: str, aws_region: str, extension: str) -> Set[str]:
    """
    List all files with given extension in S3 bucket.
    Returns a set of basenames (filename without path).
    """
    cmd = [
        "aws", "s3", "ls",
        s3_prefix.rstrip('/') + '/',
        "--recursive",
        "--region", aws_region
    ]

    env = os.environ.copy()
    env["AWS_PROFILE"] = aws_profile

    try:
        result = subprocess.run(cmd, capture_output=True, text=True, check=True, env=env)
        files = set()
        for line in result.stdout.strip().split('\n'):
            if line:
                # AWS S3 ls format: "2023-01-01 12:00:00    1234567 path/to/file.ext"
                parts = line.split()
                if len(parts) >= 4:
                    full_path = parts[3]
                    filename = Path(full_path).name
                    if filename.endswith(extension):
                        files.add(filename)
        return files
    except subprocess.CalledProcessError as e:
        print(f"Error listing S3 files: {e}")
        print(f"stderr: {e.stderr}")
        raise


def main():
    print(f"Scanning S3 bucket: {S3_BUCKET_PREFIX}")
    print(f"AWS Profile: {AWS_PROFILE}")
    print(f"AWS Region: {AWS_REGION}")
    print()

    # List all HDF5 and MP4 files in the bucket
    print("Fetching HDF5 files from S3...")
    hdf5_files = list_s3_files(S3_BUCKET_PREFIX, AWS_PROFILE, AWS_REGION, ".h5")
    print(f"Found {len(hdf5_files)} HDF5 files")

    print("Fetching MP4 files from S3...")
    mp4_files = list_s3_files(S3_BUCKET_PREFIX, AWS_PROFILE, AWS_REGION, ".mp4")
    print(f"Found {len(mp4_files)} MP4 files")
    print()

    # Find orphaned HDF5 files (HDF5 files without corresponding MP4 files)
    orphaned_hdf5 = []
    for h5_file in sorted(hdf5_files):
        # Expected MP4 filename (replace .h5 with .mp4)
        expected_mp4 = h5_file.replace('.h5', '.mp4')
        if expected_mp4 not in mp4_files:
            orphaned_hdf5.append(h5_file)

    print(f"Found {len(orphaned_hdf5)} orphaned HDF5 files (no corresponding MP4)")

    if not orphaned_hdf5:
        print("No orphaned HDF5 files found. Nothing to delete!")
        return

    # Write delete commands to file
    with open(OUTPUT_FILE, 'w') as f:
        f.write(f"# AWS CLI commands to delete orphaned HDF5 files from {S3_BUCKET_PREFIX}\n")
        f.write(f"# Generated by find_orphaned_hdf5.py\n")
        f.write(f"# Total orphaned HDF5 files: {len(orphaned_hdf5)}\n")
        f.write(f"#\n")
        f.write(f"# To execute these commands, run:\n")
        f.write(f"#   bash {OUTPUT_FILE}\n")
        f.write(f"#\n\n")

        for h5_file in orphaned_hdf5:
            s3_path = f"{S3_BUCKET_PREFIX.rstrip('/')}/{h5_file}"
            delete_cmd = f"aws s3 rm {s3_path} --region {AWS_REGION} --profile {AWS_PROFILE}\n"
            f.write(delete_cmd)

    print(f"\nâœ“ Wrote {len(orphaned_hdf5)} delete commands to: {OUTPUT_FILE}")
    print(f"\nTo review the commands:")
    print(f"  cat {OUTPUT_FILE}")
    print(f"\nTo execute the deletions (BE CAREFUL!):")
    print(f"  bash {OUTPUT_FILE}")
    print(f"\nOrphaned files:")
    for h5_file in orphaned_hdf5[:10]:  # Show first 10
        print(f"  - {h5_file}")
    if len(orphaned_hdf5) > 10:
        print(f"  ... and {len(orphaned_hdf5) - 10} more")


if __name__ == "__main__":
    main()
